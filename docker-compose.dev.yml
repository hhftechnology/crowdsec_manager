version: '3.8'

# Development docker-compose configuration
# Usage: docker-compose -f docker-compose.dev.yml up

services:
  # CrowdSec Manager - Development mode with hot reload
  crowdsec-manager-dev:
    build:
      context: .
      dockerfile: Dockerfile.dev
    container_name: crowdsec-manager-dev
    restart: unless-stopped
    ports:
      - "8080:8080"
      - "5173:5173"  # Vite dev server
    environment:
      - PORT=8080
      - ENVIRONMENT=development
      - LOG_LEVEL=debug
      - LOG_FILE=/app/logs/crowdsec-manager.log
      - DOCKER_HOST=unix:///var/run/docker.sock
      - COMPOSE_FILE=/app/docker-compose.yml
      - PANGOLIN_DIR=/app
      - CONFIG_DIR=/app/config
      - TRAEFIK_CONFIG_PATH=/app/config/traefik/dynamic_config.yml
      - BACKUP_DIR=/app/backups
      - RETENTION_DAYS=60
      - INCLUDE_CROWDSEC=true
    volumes:
      # Docker socket
      - /var/run/docker.sock:/var/run/docker.sock:ro
      # Source code for hot reload
      - ./cmd:/app/cmd
      - ./internal:/app/internal
      - ./web:/app/web
      # Configuration
      - ./config:/app/config
      - ./docker-compose.yml:/app/docker-compose.yml:ro
      # Backups
      - ./backups:/app/backups
      # Logs
      - ./logs:/app/logs
      # Go modules cache
      - go-modules:/go/pkg/mod
    networks:
      - crowdsec-network
    depends_on:
      - crowdsec
      - traefik
    command: >
      sh -c "
        cd /app &&
        go install github.com/cosmtrek/air@latest &&
        cd /app/web && npm install && npm run dev &
        cd /app && air
      "

  # Pangolin service
  pangolin:
    image: fosrl/pangolin:latest
    container_name: pangolin
    restart: unless-stopped
    networks:
      - crowdsec-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.pangolin.rule=Host(`pangolin.localhost`)"
      - "traefik.http.routers.pangolin.entrypoints=web"

  # Gerbil service
  gerbil:
    image: fosrl/gerbil:latest
    container_name: gerbil
    restart: unless-stopped
    networks:
      - crowdsec-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.gerbil.rule=Host(`gerbil.localhost`)"
      - "traefik.http.routers.gerbil.entrypoints=web"

  # CrowdSec Security Engine
  crowdsec:
    image: crowdsecurity/crowdsec:latest
    container_name: crowdsec
    restart: unless-stopped
    environment:
      - GID=${GID-1000}
      - COLLECTIONS=crowdsecurity/linux crowdsecurity/traefik
    volumes:
      - ./config/crowdsec/acquis.yaml:/etc/crowdsec/acquis.yaml:ro
      - crowdsec-db:/var/lib/crowdsec/data/
      - crowdsec-config:/etc/crowdsec/
      - traefik-logs:/var/log/traefik:ro
    networks:
      - crowdsec-network

  # Traefik Reverse Proxy
  traefik:
    image: traefik:latest
    container_name: traefik
    restart: unless-stopped
    stop_grace_period: 60s
    ports:
      - "80:80"
      - "443:443"
      - "8081:8080"
    command:
      - "--api.insecure=true"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--providers.file.directory=/etc/traefik/conf"
      - "--providers.file.watch=true"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
      - "--entrypoints.web.transport.lifecycle.gracetimeout=60s"
      - "--entrypoints.websecure.transport.lifecycle.gracetimeout=60s"
      - "--accesslog=true"
      - "--accesslog.filepath=/var/log/traefik/access.log"
      - "--log.level=DEBUG"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./config/traefik:/etc/traefik/conf:ro
      - traefik-logs:/var/log/traefik
    networks:
      - crowdsec-network
    labels:
      - "traefik.enable=true"

networks:
  crowdsec-network:
    driver: bridge

volumes:
  crowdsec-db:
  crowdsec-config:
  traefik-logs:
  go-modules:
